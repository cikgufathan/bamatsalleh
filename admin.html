<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN CONSOLE - Arabic Merit Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5; --bg: #0f172a; --card: #1e293b;
            --text: #f8fafc; --success: #22c55e; --danger: #ef4444;
            --warning: #eab308; --info: #06b6d4; --dark: #334155;
            --gold: #fbbf24;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .desktop-container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr; gap: 20px; }

        /* SIDEBAR */
        .sidebar { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #334155; height: fit-content; position: sticky; top: 20px; }
        header { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); }
        .sync-badge { font-size: 0.75rem; padding: 5px 12px; border-radius: 20px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); display: inline-block; margin-top: 10px; }

        /* MAIN CONTENT */
        .main-content { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid #334155; min-height: 80vh; }
        
        /* TABS KELAS */
        .tabs-container { background: #0f172a; padding: 10px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 8px; overflow-x: auto; border: 1px solid #334155; min-height: 50px; align-items: center; }
        .tab-btn { padding: 10px 20px; border-radius: 8px; border: 1px solid #475569; background: #1e293b; color: #94a3b8; cursor: pointer; white-space: nowrap; font-weight: 600; transition: 0.2s; }
        .tab-btn.active { background: var(--gold); color: black; border-color: var(--gold); box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }

        /* CONTROLS */
        .admin-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-action { padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.85rem; transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.98); }

        .search-bar { width: 100%; padding: 15px; border: 1px solid #475569; background: #0f172a; color: white; border-radius: 10px; margin-bottom: 20px; font-size: 1rem; box-sizing: border-box; outline: none; }
        .search-bar:focus { border-color: var(--gold); }

        /* TABLE */
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; }
        th { text-align: left; padding: 15px; background: #0f172a; color: #94a3b8; border-bottom: 2px solid #334155; }
        td { padding: 15px; background: #252f45; border: 1px solid #334155; vertical-align: middle; }
        tr:hover td { background: #334155; border-color: var(--gold); }
        tr td:first-child { border-radius: 8px 0 0 8px; }
        tr td:last-child { border-radius: 0 8px 8px 0; }

        /* SCORING BUTTONS (LAYOUT BARU) */
        .score-btns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; width: 100%; }
        .btn-pts { padding: 10px 2px; border: none; border-radius: 6px; color: white; font-weight: 700; cursor: pointer; font-size: 0.7rem; transition: 0.2s; letter-spacing: 0.5px; }
        .btn-pts:hover { opacity: 0.8; }
        .btn-pts:active { transform: scale(0.95); }
        
        .rank-tag { font-size: 0.7rem; padding: 4px 10px; border-radius: 6px; color: white; font-weight: bold; text-transform: uppercase; display: inline-block; margin-top: 5px; }

        /* MODALS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
        .modal { background: #1e293b; padding: 30px; border-radius: 15px; width: 400px; box-shadow: 0 0 30px rgba(0,0,0,0.5); text-align: center; border: 1px solid #475569; }
        .modal input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #475569; background: #0f172a; color: white; border-radius: 8px; box-sizing: border-box; }
        .modal h3 { color: var(--gold); margin-top: 0; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { padding: 15px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; text-align: center; }
        
        /* TOAST */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--gold); color: black; padding: 12px 24px; border-radius: 8px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideUp 0.3s forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    </style>
</head>
<body onload="init()">

<div id="toast-container"></div>

<div class="desktop-container">
    <div class="sidebar">
        <header>
            <h2 style="margin:0; font-weight: 900; letter-spacing: 1px;"><i class="fas fa-crown"></i> MERIT PRO</h2>
            <small style="opacity:0.9; font-size: 0.9rem;">Panel Kawalan Guru</small>
            <br>
            <div id="syncStatus" class="sync-badge">Menghubungkan...</div>
        </header>

        <div class="stats-grid">
            <div class="stat-box">
                <small style="font-weight:bold; color:#94a3b8">JUMLAH PELAJAR</small>
                <div id="totalStu" style="font-size:1.6rem; font-weight:900; color:var(--info)">0</div>
            </div>
            <div class="stat-box">
                <small style="font-weight:bold; color:#94a3b8">TOTAL POINTS</small>
                <div id="totalPts" style="font-size:1.6rem; font-weight:900; color:var(--gold)">0</div>
            </div>
        </div>

        <div style="height: 200px; margin-bottom: 25px;"><canvas id="sideChart"></canvas></div>

        <div class="admin-controls" id="controlPanel" style="display:none">
            <button class="btn-action" style="background:var(--success)" onclick="openM('addM')"><i class="fas fa-user-plus"></i> Tambah Pelajar</button>
            <button class="btn-action" style="background:var(--info)" onclick="openM('addClassM')"><i class="fas fa-folder-plus"></i> Tambah Kelas</button>
            <button class="btn-action" style="background:var(--warning); color:black;" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> Cetak PDF</button>
            <button class="btn-action" style="background:var(--dark)" onclick="exportCSV()"><i class="fas fa-download"></i> Backup CSV</button>
            <button class="btn-action" style="background:var(--danger); grid-column: span 2;" onclick="openM('resetM')"><i class="fas fa-bomb"></i> RESET SEMUA MARKAH</button>
            <button class="btn-action" style="background:#475569; grid-column: span 2; margin-top:10px" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <div id="loginArea">
            <div style="text-align:center; margin-bottom:20px; color:var(--gold);"><i class="fas fa-lock fa-3x"></i></div>
            <p style="text-align:center; color:#94a3b8; font-size:0.9rem;">Masukkan Password Admin</p>
            <input type="password" id="passInput" style="width:100%; padding:15px; border-radius:8px; border:1px solid #475569; background:#0f172a; color:white; margin-bottom:15px; text-align:center;" onkeypress="if(event.key==='Enter') checkLogin()">
            <button class="btn-action" style="background:var(--primary); width:100%; padding: 15px;" onclick="checkLogin()">MASUK SYSTEM</button>
        </div>
    </div>

    <div class="main-content">
        <div class="tabs-container" id="tabContainer"></div>
        
        <input type="text" id="search" class="search-bar" placeholder="üîç Cari nama pelajar..." onkeyup="refresh()">

        <div style="overflow-x: auto;">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th style="width: 60px; text-align:center;">RANK</th>
                        <th>NAMA PELAJAR</th>
                        <th style="text-align:center; width: 120px">MARKAH</th>
                        <th id="thAction" style="display:none; width: 350px;">PANEL MARKAH</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="addM" class="overlay"><div class="modal">
    <h3><i class="fas fa-user-plus"></i> Tambah Pelajar</h3>
    <input type="text" id="newName" placeholder="Nama Penuh Pelajar (Huruf Besar)" onkeypress="if(event.key==='Enter') saveNew()">
    <button class="btn-action" style="background:var(--success); width:100%" onclick="saveNew()">Simpan</button>
    <button class="btn-action" style="background:#334155; width:100%; margin-top:10px;" onclick="closeM('addM')">Batal</button>
</div></div>

<div id="addClassM" class="overlay"><div class="modal">
    <h3><i class="fas fa-folder-plus"></i> Tambah Kelas</h3>
    <input type="text" id="newClassName" placeholder="Contoh: 4 SETIA" onkeypress="if(event.key==='Enter') saveNewClass()">
    <button class="btn-action" style="background:var(--info); width:100%" onclick="saveNewClass()">Simpan</button>
    <button class="btn-action" style="background:#334155; width:100%; margin-top:10px;" onclick="closeM('addClassM')">Batal</button>
</div></div>

<div id="resetM" class="overlay"><div class="modal" style="border: 2px solid var(--danger);">
    <h3 style="color:var(--danger)">AMARAN KERAS!</h3>
    <p>Adakah anda pasti mahu memadam <b>SEMUA MARKAH</b> untuk kelas <br><b id="resetClassName" style="font-size:1.2rem; color:white"></b>?</p>
    <button class="btn-action" style="background:var(--danger); width:100%" onclick="confirmReset()">YA, PADAM SEMUA</button>
    <button class="btn-action" style="background:#334155; width:100%; margin-top:10px;" onclick="closeM('resetM')">BATAL</button>
</div></div>

<script>
    // --- SETTING WAJIB: MASUKKAN URL SCRIPT DI SINI ---
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbw8gWAH5xpdKATiCC33VL3GcIUnRMGqms0NYsSXDVLZQxOGTMNKRWyG7d5xxGf-T0-X/exec";
    
    // PASSWORD ADMIN (Default: admin123) - Boleh tukar sini
    const SECRET_KEY = "YWRtaW4xMjM="; // Ini ialah "admin123" dalam base64
    
    let db = [];
    let classes = [];
    let activeCls = "";
    let isAdmin = false;
    let chart;

    async function init() {
        // Load local dulu supaya cepat
        const local = localStorage.getItem("ARABIC_DB_PRO");
        if(local) { db = JSON.parse(local); updateClassList(); refresh(); }
        
        // Lepas tu ambil dari cloud
        await loadCloud();
    }

    async function loadCloud() {
        try {
            status("üîÑ Syncing...", "color:#fbbf24");
            const res = await fetch(CLOUD_URL);
            const data = await res.json();
            
            if(data.length > 0) {
                // Map data dari array [nama, skor, kelas]
                db = data.map(r => ({ n: String(r.n || r[0]), s: parseInt(r.s || r[1]) || 0, c: String(r.c || r[2]) }));
                localStorage.setItem("ARABIC_DB_PRO", JSON.stringify(db));
                updateClassList();
                status("‚úÖ Online", "color:#22c55e");
            }
            refresh();
        } catch (e) { status("‚ö†Ô∏è Offline", "color:#ef4444"); console.log(e); }
    }

    async function sync() {
        // Simpan local
        localStorage.setItem("ARABIC_DB_PRO", JSON.stringify(db));
        
        // Hantar ke Google Sheet (Format Array 2D)
        // Kita hantar semua data untuk pastikan sync tepat
        const rows = db.map(p => [p.n, p.s, p.c]);
        
        try {
            status("üîÑ Saving...", "color:#fbbf24");
            await fetch(CLOUD_URL, { 
                method: "POST", 
                mode: 'no-cors', // Penting untuk elak CORS error di browser
                body: JSON.stringify({ action: "bulk_update", data: rows }) 
            });
            // Kerana no-cors, kita assume berjaya jika tiada error network
            setTimeout(() => status("‚úÖ Saved", "color:#22c55e"), 1000);
        } catch (e) { status("‚ö†Ô∏è Save Error", "color:#ef4444"); }
    }

    function updateClassList() {
        // Cari semua kelas unik
        const currentClasses = [...new Set(db.map(x => x.c))].sort();
        classes = currentClasses;
        
        if(classes.length === 0) classes = ["DEFAULT"];
        if(!activeCls || !classes.includes(activeCls)) activeCls = classes[0];
        
        renderTabs();
    }

    function renderTabs() { 
        document.getElementById('tabContainer').innerHTML = classes.map(c => 
            `<button class="tab-btn ${c===activeCls?'active':''}" onclick="setCls('${c}')">${c}</button>`
        ).join(''); 
    }
    
    function setCls(c) { 
        activeCls = c; 
        renderTabs(); 
        refresh(); 
    }

    function getRank(s) {
        if(s >= 300) return { l:"KHALIFAH", c:"#7c3aed", i:"fa-crown" };
        if(s >= 150) return { l:"ELITE", c:"#f59e0b", i:"fa-medal" };
        if(s >= 50) return { l:"PRO", c:"#3b82f6", i:"fa-shield-alt" };
        return { l:"NEWBIE", c:"#22c55e", i:"fa-seedling" };
    }

    function refresh() {
        const q = document.getElementById('search').value.toUpperCase();
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = "";
        
        let list = db.filter(x => x.c === activeCls).sort((a,b) => b.s - a.s);
        
        // Update Stats
        document.getElementById('totalStu').innerText = list.length;
        document.getElementById('totalPts').innerText = list.reduce((a,b)=>a+b.s,0);

        list.forEach((p, idx) => {
            if(!p.n.toUpperCase().includes(q)) return;
            const rank = getRank(p.s);
            const tr = document.createElement('tr');
            
            // Icon Rank 1, 2, 3
            let rankDisplay = `<span style="color:#64748b; font-weight:bold;">#${idx+1}</span>`;
            if(idx === 0) rankDisplay = 'ü•á';
            if(idx === 1) rankDisplay = 'ü•à';
            if(idx === 2) rankDisplay = 'ü•â';

            tr.innerHTML = `
                <td style="text-align:center; font-size:1.2rem;">${rankDisplay}</td>
                <td>
                    <div style="font-weight:700; font-size:1rem; color:white;">${p.n}</div>
                    <span class="rank-tag" style="background:${rank.c}; color:white;"><i class="fas ${rank.i}"></i> ${rank.l}</span>
                </td>
                <td style="text-align:center;">
                    <div style="font-size:1.5rem; font-weight:900; color:${p.s>0?'var(--gold)':'#64748b'}">${p.s}</div>
                </td>
                ${isAdmin ? `<td>
                    <div style="display: flex; gap: 5px; align-items: flex-start;">
                        <div class="score-btns">
                            <button class="btn-pts" style="background:#16a34a" onclick="mod('${p.n}', 4)">üìñ HAFAL (+4)</button>
                            <button class="btn-pts" style="background:#ef4444" onclick="mod('${p.n}', -4)">‚ùå T.HAFAL (-4)</button>

                            <button class="btn-pts" style="background:#3b82f6" onclick="mod('${p.n}', 8)">üìù SIAP (+8)</button>
                            <button class="btn-pts" style="background:#ef4444" onclick="mod('${p.n}', -8)">‚ùå T.SIAP (-8)</button>

                            <button class="btn-pts" style="background:var(--gold); color:black; grid-column:span 2" onclick="mod('${p.n}', 10)">üî• EARLY BIRD (+10)</button>

                            <button class="btn-pts" style="background:#a855f7" onclick="mod('${p.n}', 5)">üëã HADIR (+5)</button>
                            <button class="btn-pts" style="background:#ef4444" onclick="mod('${p.n}', -8)">üö´ T.HADIR (-8)</button>
                            
                            <button class="btn-pts" style="background:#14b8a6" onclick="mod('${p.n}', 1)">‚≠ê TERPUJI (+1)</button>
                            <button class="btn-pts" style="background:#334155" onclick="mod('${p.n}', -1)">‚ö†Ô∏è DISIPLIN (-1)</button>
                        </div>
                        <button onclick="delStu('${p.n}')" style="background:#991b1b; border:none; border-radius:5px; color:white; padding:10px; height:100%; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>
                </td>` : ''}
            `;
            tbody.appendChild(tr);
        });
        updateChart(list.slice(0,5));
    }

    // UPDATE MARKAH (LOGIK BARU)
    function mod(n, v) {
        const p = db.find(x => x.n === n && x.c === activeCls);
        if(p) { 
            p.s += v; 
            refresh(); // Update UI serta merta
            showToast(`${n}: ${v>0?'+':''}${v}`, "success");
            
            // Hantar ke Cloud (Background)
            sync(); 
        }
    }

    function showToast(msg) {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast`;
        t.innerText = msg;
        c.appendChild(t);
        setTimeout(() => { t.remove() }, 2000);
    }

    function delStu(n) {
        if(confirm(`Padam pelajar ${n}?`)) { 
            db = db.filter(x => !(x.n === n && x.c === activeCls)); 
            refresh(); sync(); 
        }
    }

    function confirmReset() {
        db.forEach(p => { if(p.c === activeCls) p.s = 0; });
        refresh(); sync(); closeM('resetM');
    }

    function updateChart(data) {
        const ctx = document.getElementById('sideChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(x => x.n.split(' ')[0]),
                datasets: [{ data: data.map(x => x.s), backgroundColor: ['#fbbf24','#94a3b8','#cd7f32','#4f46e5','#6366f1'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function checkLogin() {
        const inputPass = document.getElementById('passInput').value;
        // Password ialah admin123
        if(inputPass === "admin123") {
            isAdmin = true;
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('controlPanel').style.display = 'grid';
            document.getElementById('thAction').style.display = 'table-cell';
            refresh();
        } else {
            alert("Password Salah!");
        }
    }

    function logout() { location.reload(); }
    
    function status(m, s) { const el = document.getElementById('syncStatus'); el.innerText = m; el.style = s; }
    function openM(id) { 
        if(id === 'resetM') document.getElementById('resetClassName').innerText = activeCls;
        document.getElementById(id).style.display = 'flex'; 
    }
    function closeM(id) { document.getElementById(id).style.display = 'none'; }

    function saveNew() {
        const n = document.getElementById('newName').value.toUpperCase().trim();
        if(n) { db.push({n, s:0, c:activeCls}); sync(); refresh(); closeM('addM'); document.getElementById('newName').value=""; }
    }

    function saveNewClass() {
        const c = document.getElementById('newClassName').value.toUpperCase().trim();
        if(c && !classes.includes(c)) { 
            db.push({n: "PELAJAR CONTOH", s:0, c:c}); 
            activeCls = c; updateClassList(); sync(); refresh(); closeM('addClassM'); 
        }
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf; const d = new jsPDF();
        d.text(`LAPORAN MERIT: ${activeCls}`, 14, 15);
        d.autoTable({ head:[['Rank','Nama','Markah','Status']], body: db.filter(x=>x.c===activeCls).sort((a,b)=>b.s-a.s).map((p,i)=>[i+1, p.n, p.s, getRank(p.s).l]), startY: 20 });
        d.save(`Laporan_${activeCls}.pdf`);
    }

    function exportCSV() {
        let csv = "Nama,Markah,Kelas\n" + db.map(p => `"${p.n}",${p.s},${p.c}`).join("\n");
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        a.download = `Backup_Merit.csv`; a.click();
    }
</script>
</body>
</html>
